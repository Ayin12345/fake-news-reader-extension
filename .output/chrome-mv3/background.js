var background=function(){"use strict";var I,v;async function M(r,n){var o;const e=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:r}]})})).json();if(e.choices&&e.choices[0]&&e.choices[0].message.content)return e.choices[0].message.content;throw new Error(((o=e.error)==null?void 0:o.message)||"No response from OpenAI")}async function O(r,n){var o;const t=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:r}]}],generationConfig:{temperature:.7,maxOutputTokens:1e3}})});if(!t.ok){const i=await t.text();throw new Error(`Gemini API error: ${t.status} ${t.statusText} - ${i}`)}const e=await t.json();if(e.candidates&&e.candidates[0]&&e.candidates[0].content&&e.candidates[0].content.parts&&e.candidates[0].content.parts[0])return e.candidates[0].content.parts[0].text;throw new Error(((o=e.error)==null?void 0:o.message)||"No response from Gemini")}async function W(r,n){var t;console.log("Llama API Key:","Present"),console.log("API Key length:",n.length);try{const e=await fetch("https://api-inference.huggingface.co/models/meta-llama/Llama-3.3-70B-Instruct",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Llama Response Status:",e.status,e.statusText),!e.ok){const i=await e.text();throw console.error("Llama API Full Error:",{status:e.status,statusText:e.statusText,errorText:i,headers:Object.fromEntries(e.headers.entries())}),new Error(`Llama API error: ${e.status} ${e.statusText} - ${i}`)}const o=await e.json();if(console.log("Llama API Response Data:",o),Array.isArray(o)&&((t=o[0])!=null&&t.generated_text))return o[0].generated_text;throw console.error("Llama API Invalid Response Format:",o),new Error(o.error||"No valid response from Llama")}catch(e){throw console.error("Llama API Call Failed:",e),e}}async function L(r,n){console.log("Cohere API Key:","Present"),console.log("Cohere API Key length:",n.length);try{const t=await fetch("https://api.cohere.ai/v1/generate",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({model:"command",prompt:r,max_tokens:1250})});if(console.log("Cohere Response Status:",t.status,t.statusText),!t.ok){const o=await t.text();throw console.error("Cohere API Full Error:",{status:t.status,statusText:t.statusText,errorText:o,headers:Object.fromEntries(t.headers.entries())}),new Error(`Cohere API error: ${t.status} ${t.statusText} - ${o}`)}const e=await t.json();if(console.log("Cohere API Response Data:",e),e.generations&&e.generations[0]&&e.generations[0].text)return e.generations[0].text;throw new Error(e.message||"No response from Cohere")}catch(t){throw console.error("Cohere API Call Failed:",t),t}}async function j(r,n){var t;try{const e=await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.3",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Mistral Response Status:",e.status,e.statusText),!e.ok){const i=await e.text();throw console.error("Mistral API Full Error:",{status:e.status,statusText:e.statusText,errorText:i,headers:Object.fromEntries(e.headers.entries())}),new Error(`Mistral API error: ${e.status} ${e.statusText} - ${i}`)}const o=await e.json();if(console.log("Mistral API Response Data:",o),Array.isArray(o)&&((t=o[0])!=null&&t.generated_text))return o[0].generated_text;throw console.error("Mistral API Invalid Response Format:",o),new Error(o.error||"No valid response from Mistral 7B")}catch(e){throw console.error("Mistral API Call Failed:",e),e}}async function z(r,n){try{const t=await fetch("https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Mixtral Response Status:",t.status,t.statusText),!t.ok){const o=await t.text();throw console.error("Mixtral API Full Error:",{status:t.status,statusText:t.statusText,errorText:o,headers:Object.fromEntries(t.headers.entries())}),new Error(`Mixtral API error: ${t.status} ${t.statusText} - ${o}`)}const e=await t.json();if(console.log("Mixtral API Response Data:",e),Array.isArray(e)&&e[0]&&e[0].generated_text)return e[0].generated_text;throw console.error("Mixtral API Invalid Response Format:",e),new Error(e.error||"No response from Mixtral 8x7B")}catch(t){throw console.error("Mixtral API Call Failed:",t),t}}function D(r){return r==null||typeof r=="function"?{main:r}:r}async function q(r,n=5){var t,e;try{console.log("=== WEB SEARCH DEBUG START ==="),console.log("Original query received:",r),console.log("Max results requested:",n),console.log("Google API Key present:",!0),console.log("Google Search Engine ID present:",!0);let o="";try{const s=r.match(/https?:\/\/([^\/]+)/);s&&(o=s[1].replace("www.",""))}catch{console.log("Could not extract domain from query")}const i=r.replace(/https?:\/\/[^\s]+/g,"").trim();let c="";try{const s=r.match(/https?:\/\/([^\/]+)/);s&&(c=s[1].replace("www.",""))}catch{console.log("Could not extract current domain from query")}const d=c?`${i} -site:${c}`:i;console.log("Enhanced search query:",d),console.log("Encoded query:",encodeURIComponent(d));const m=`https://www.googleapis.com/customsearch/v1?key=AIzaSyAIQCMO6dv-Ywnqfv2ctmV-UlBD3z1xHzI&cx=c424f03b2cfd34523&q=${encodeURIComponent(d)}&num=${n}&fields=items(title,snippet,link)`;console.log("Full search URL (without API key):",m.replace("AIzaSyAIQCMO6dv-Ywnqfv2ctmV-UlBD3z1xHzI","API_KEY_HIDDEN"));const g=await fetch(m);if(console.log("Search response status:",g.status,g.statusText),console.log("Search response headers:",Object.fromEntries(g.headers.entries())),!g.ok){const s=await g.text();throw console.error("Search API error response:",s),new Error(`Search API error: ${g.status} - ${s}`)}const l=await g.json();console.log("Raw search API response:",l),console.log("Number of results returned:",((t=l.items)==null?void 0:t.length)||0),l.items&&l.items.length>0?(console.log("Detailed search results:"),l.items.forEach((s,h)=>{var w;console.log(`Result ${h+1}:`),console.log(`  Title: ${s.title}`),console.log(`  URL: ${s.link}`),console.log(`  Snippet: ${(w=s.snippet)==null?void 0:w.substring(0,100)}...`)})):console.log("No search results found");const a=((e=l.items)==null?void 0:e.filter(s=>{const h=s.link.toLowerCase(),w=s.title.toLowerCase();if(c&&h.includes(c))return console.log(`Filtering out result from same domain: ${s.link}`),!1;const A=i.toLowerCase().split(" ").filter(p=>p.length>3);return A.filter(p=>w.includes(p)).length>A.length*.7?(console.log(`Filtering out too similar title: ${s.title}`),!1):!0}).map(s=>({url:s.link,title:s.title,snippet:s.snippet})))||[];return console.log("Processed results being returned:",a),console.log("=== WEB SEARCH DEBUG END ==="),a}catch(o){return console.error("Web search failed:",o),[]}}const u=new Map,f=()=>({pageInfo:null,analysis:[],failedProviders:[],showButton:!0,isAnalyzing:!1}),F=D({main(){chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed")}),chrome.action.onClicked.addListener(()=>{chrome.sidePanel.open({windowId:chrome.windows.WINDOW_ID_CURRENT})}),chrome.tabs.onRemoved.addListener(r=>{u.delete(r)}),chrome.tabs.onActivated.addListener(async r=>{try{console.log("Tab switched to:",r.tabId);const n=u.get(r.tabId);n&&n.analysis&&(console.log("Tab switch - Analysis state:",n.analysis),console.log("Analysis length:",n.analysis.length),n.analysis.forEach((t,e)=>{console.log(`Tab switch - Analysis ${e}:`,t.provider,t.result.credibility_summary)})),chrome.runtime.sendMessage({type:"TAB_SWITCHED",tabId:r.tabId,state:n||f()}).catch(t=>{console.log("Sidebar not open or not ready:",t)})}catch(n){console.log("Error handling tab switch:",n)}}),chrome.runtime.onMessage.addListener((r,n,t)=>r.type==="GET_PAGE_INFO"?((async()=>{var e;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(o!=null&&o.id)){t({success:!1,error:"No active tab found"});return}const i=await chrome.tabs.sendMessage(o.id,{type:"GET_PAGE_CONTENT"});if(i&&i.error){t({success:!1,error:i.error});return}let c=u.get(o.id)||f();const d=((e=c.pageInfo)==null?void 0:e.url)===i.data.url;c={...c,pageInfo:i.data,showButton:!0,analysis:d?c.analysis:[],failedProviders:d?c.failedProviders:[]},u.set(o.id,c),t({success:!0,data:i.data})}catch{t({success:!1,error:"Failed to fetch page info"})}})(),!0):r.type==="ANALYZE_ARTICLE"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){t({success:!1,error:"No active tab found"});return}const o=r.providers||[];let i=u.get(e.id)||f();i.isAnalyzing=!0,u.set(e.id,i),console.log("Providers array received:",o),console.log("Providers array length:",o.length),console.log("API Keys Debug:"),console.log("Cohere key length:",40),console.log("Cohere key starts with:","d4rtWmY3HK9su8mrSbxlsrWEJod7TZyGeNH3ZvdG".substring(0,5)||"none"),console.log("Gemini key length:",39),console.log("HuggingFace key length:",37),console.log("HuggingFace key starts with:","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".substring(0,5)||"none");const c=o.map(async a=>{console.log(`Trying provider: ${a}`);try{let s;switch(a){case"OpenAI":s=await M(r.content,"");break;case"Gemini":s=await O(r.content,"AIzaSyA82I5_GdxU23af9sklb3mLb8T-tuPP1BE");break;case"Cohere":s=await L(r.content,"d4rtWmY3HK9su8mrSbxlsrWEJod7TZyGeNH3ZvdG");break;case"Mistral7B":s=await j(r.content,"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");break;case"Mixtral8x7B":s=await z(r.content,"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");break;case"Llama":s=await W(r.content,"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");break;default:throw new Error(`Unknown provider: ${a}`)}return chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:a,status:"complete"}),console.log(`Provider ${a} completed successfully`),s}catch(s){throw console.error(`Error in provider ${a}:`,s),chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:a,status:"failed"}),console.log(`Provider ${a} failed`),s}}),d=await Promise.allSettled(c),m=d.map((a,s)=>{if(a.status==="fulfilled")try{let h;if(typeof a.value=="string")try{h=JSON.parse(a.value)}catch{const A=a.value.match(/credibility_score["\s:]+(\d+)/),P=a.value.match(/credibility_summary["\s:]+(.+?)(?=reasoning|supporting_links|evidence_sentences|$)/s),p=a.value.match(/reasoning["\s:]+(.+?)(?=supporting_links|evidence_sentences|$)/s),_=a.value.match(/evidence_sentences["\s:]+\[(.*?)\]/s),S=a.value.match(/supporting_links["\s:]+\[(.*?)\]/s);let $=[];_&&($=(_[1].match(/\{[^{}]*\}/g)||[]).map(y=>{var B,C;try{const E=JSON.parse(y);return{quote:((B=E.quote)==null?void 0:B.trim().replace(/['"]+/g,""))||"",impact:((C=E.impact)==null?void 0:C.trim().replace(/['"]+/g,""))||""}}catch{const N=y.match(/quote["\s:]+([^,}]+)/),k=y.match(/impact["\s:]+([^,}]+)/);return{quote:N?N[1].trim().replace(/['"]+/g,""):"",impact:k?k[1].trim().replace(/['"]+/g,""):""}}}).filter(y=>y.quote&&y.impact)),h={credibility_score:A?parseInt(A[1]):0,credibility_summary:P?P[1].trim().replace(/['"]+/g,"").replace(/[.,]+$/,""):"No summary provided",reasoning:p?p[1].trim().replace(/['"]+/g,"").replace(/[.,]+$/,""):a.value,evidence_sentences:$,supporting_links:S?S[1].split(",").map(b=>b.trim().replace(/['"]+/g,"")).filter(b=>b.length>0):[]}}else h=a.value;return h?{provider:o[s],result:h}:null}catch{return null}return null}).filter(a=>a!==null),g=d.map((a,s)=>(console.log(`Provider ${o[s]} status:`,a.status),a.status==="rejected"?(console.error(`Provider ${o[s]} failed:`,a.reason),o[s]):(a.status==="fulfilled"&&console.log(`Provider ${o[s]} succeeded`),null))).filter(a=>a!==null);let l=u.get(e.id);l||(console.warn("No existing tab state found during analysis"),l=f()),l.analysis=m,l.failedProviders=g,l.showButton=!1,l.isAnalyzing=!1,console.log("Saving analysis state:",m),console.log("Analysis length:",m.length),m.forEach((a,s)=>{console.log(`Saving - Analysis ${s}:`,a.provider,a.result.credibility_summary)}),u.set(e.id,l),t({success:!0,data:d,providers:o})}catch{t({success:!1,error:"Failed to analyze article"})}})(),!0):r.type==="GET_TAB_STATE"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){t({success:!1,error:"No active tab found"});return}const o=u.get(e.id)||f();t({success:!0,data:o})}catch{t({success:!1,error:"Failed to get tab state"})}})(),!0):r.type==="RESET_TAB_STATE"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){t({success:!1,error:"No active tab found"});return}u.set(e.id,f()),t({success:!0})}catch{t({success:!1,error:"Failed to reset tab state"})}})(),!0):r.type==="SAVE_TAB_STATE"?((async()=>{try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id)){t({success:!1,error:"No active tab found"});return}u.set(e.id,{pageInfo:r.data.pageInfo,analysis:r.data.analysis,failedProviders:r.data.failedProviders,showButton:r.data.showButton,isAnalyzing:r.data.isAnalyzing||!1}),t({success:!0})}catch{t({success:!1,error:"Failed to save tab state"})}})(),!0):r.type==="WEB_SEARCH"?((async()=>{try{const e=await q(r.query,r.max_results);t({success:!0,data:{results:e}})}catch(e){console.error("Web search error:",e),t({success:!1,error:"Failed to perform web search"})}})(),!0):(r.type==="TAB_SWITCHED",!0))}});function H(){}(v=(I=globalThis.browser)==null?void 0:I.runtime)!=null&&v.id?globalThis.browser:globalThis.chrome;function T(r,...n){}const G={debug:(...r)=>T(console.debug,...r),log:(...r)=>T(console.log,...r),warn:(...r)=>T(console.warn,...r),error:(...r)=>T(console.error,...r)};let x;try{x=F.main(),x instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(r){throw G.error("The background crashed on startup!"),r}return x}();
background;
