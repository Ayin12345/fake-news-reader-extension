var background=function(){"use strict";var D,N;function k(t){return t==null||typeof t=="function"?{main:t}:t}const I="https://fake-news-reader-extension.onrender.com";async function _(t){try{const a={"Content-Type":"application/json"},e=await fetch(`${I}/api/analyze`,{method:"POST",headers:a,body:JSON.stringify(t)});if(!e.ok){const r=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(r.error||`HTTP ${e.status}`)}return await e.json()}catch(a){return console.error("[BackendClient] Analyze error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to call backend"}}}async function v(t){try{const a={"Content-Type":"application/json"},e=await fetch(`${I}/api/web-search`,{method:"POST",headers:a,body:JSON.stringify(t)});if(!e.ok){const r=await e.text();let s;try{s=JSON.parse(r)}catch{s={error:r||`HTTP ${e.status}`}}throw new Error(s.error||`HTTP ${e.status}`)}return await e.json()}catch(a){return console.error("[BackendClient] Web search error:",a),{success:!1,error:a instanceof Error?a.message:"Failed to call backend"}}}const B=Object.freeze(Object.defineProperty({__proto__:null,callBackendAnalyze:_,callBackendWebSearch:v},Symbol.toStringTag,{value:"Module"})),w=new Map,E=new Set,m=()=>({pageInfo:null,analysis:[],failedProviders:[],showButton:!0,isAnalyzing:!1,hasAttemptedAnalysis:!1});async function b(t,a){try{const r=(await chrome.storage.local.get("tabStates")).tabStates||{};r[t]=a,await chrome.storage.local.set({tabStates:r}),w.set(t,a)}catch(e){console.error("Failed to save tab state:",e),w.set(t,a)}}async function T(t){if(w.has(t))return w.get(t);try{const r=((await chrome.storage.local.get("tabStates")).tabStates||{})[t];if(r)return w.set(t,r),r}catch(a){console.error("Failed to get tab state:",a)}}async function P(t){try{const e=(await chrome.storage.local.get("tabStates")).tabStates||{};delete e[t],await chrome.storage.local.set({tabStates:e}),w.delete(t)}catch(a){console.error("Failed to delete tab state:",a),w.delete(t)}}function F(t){return E.has(t)}function O(t){E.add(t)}function y(t){E.delete(t)}const L=async()=>{try{const a=(await chrome.storage.local.get("tabStates")).tabStates||{},e=await chrome.tabs.query({}),r=new Set(e.map(o=>o.id));let s=!1;for(const o of Object.keys(a))r.has(parseInt(o))||(delete a[o],s=!0);s&&await chrome.storage.local.set({tabStates:a})}catch(t){console.error("Error cleaning up tab states:",t)}};async function x(t,a,e){var r,s;try{const o=t.tabId||((r=a.tab)==null?void 0:r.id);if(!o){e({success:!1,error:"No tab ID found"});return}const c=await chrome.tabs.sendMessage(o,{type:"GET_PAGE_CONTENT"});if(c&&c.error){e({success:!1,error:c.error});return}let n=await T(o)||m();const l=((s=n.pageInfo)==null?void 0:s.url)===c.data.url;n={...n,pageInfo:c.data,showButton:!0,analysis:l?n.analysis:[],failedProviders:l?n.failedProviders:[],hasAttemptedAnalysis:!1},await b(o,n),e({success:!0,data:c.data})}catch(o){console.error("Error getting page info:",o),e({success:!1,error:"Failed to fetch page info"})}}async function C(t,a,e){var r,s,o,c;try{const n=t.tabId;if(!n){e({success:!1,error:"No tab ID provided"});return}const l=t.providers||[];let g=await T(n)||m();g.isAnalyzing=!0,await b(n,g),l.forEach(i=>{chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:i,status:"analyzing"})});const h=t.content.match(/"supporting_links":\s*\[(.*?)\]/);let d=[];if(h)try{const i=h[1];i.trim()&&(d=i.split(",").map(A=>A.trim().replace(/^"|"$/g,"").trim()).filter(Boolean))}catch(i){console.warn("Failed to extract supporting links from prompt:",i)}const u=await _({prompt:t.content,providers:l,requestId:Date.now(),supportingLinks:d});if(!u.success){l.forEach(A=>{chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:A,status:"failed",error:u.error||"Backend request failed"})});let i=await T(n);i&&(i.isAnalyzing=!1,await b(n,i)),e({success:!1,error:u.error||"Failed to analyze article"});return}u.data&&(u.data.successfulResults.forEach(i=>{chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:i.provider,status:"complete"})}),u.data.failedProviders.forEach(i=>{const A=typeof i=="string"?i:i.provider,q=typeof i=="string"?"Provider failed":i.error||"Provider failed";chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:A,status:"failed",error:q})}));let f=await T(n);f||(f=m()),f.analysis=((r=u.data)==null?void 0:r.successfulResults)||[],f.failedProviders=((s=u.data)==null?void 0:s.failedProviders)||[],f.showButton=!1,f.isAnalyzing=!1,f.hasAttemptedAnalysis=!0,await b(n,f),e({success:!0,data:{successfulResults:((o=u.data)==null?void 0:o.successfulResults)||[],failedProviders:((c=u.data)==null?void 0:c.failedProviders)||[]},providers:l})}catch(n){console.error("Error in analyze article:",n),e({success:!1,error:n instanceof Error?n.message:"Failed to analyze article"})}}async function j(t,a,e){var r,s;try{const o=t.tabId||((r=a.tab)==null?void 0:r.id);if(!o){e({success:!1,error:"No tab ID found"});return}if(t.url){const l=(await chrome.storage.local.get("tabStates")).tabStates||{};for(const[g,h]of Object.entries(l)){const d=h;if(((s=d.pageInfo)==null?void 0:s.url)===t.url&&d.analysis&&d.analysis.length>0){e({success:!0,data:d});return}}e({success:!0,data:m()});return}const c=await T(o)||m();e({success:!0,data:c})}catch(o){console.error("Error in GET_TAB_STATE:",o),e({success:!1,error:"Failed to get tab state"})}}async function G(t,a,e){var r;try{const s=t.tabId||((r=a.tab)==null?void 0:r.id);if(!s){e({success:!1,error:"No tab ID found"});return}await P(s);const o=m();await b(s,o),chrome.tabs.sendMessage(s,{type:"TAB_SWITCHED",state:o}).catch(()=>{}),e({success:!0})}catch(s){console.error("Error resetting tab state:",s),e({success:!1,error:"Failed to reset tab state"})}}async function M(t,a,e){var r;try{const s=t.tabId||((r=a.tab)==null?void 0:r.id);if(!s){e({success:!1,error:"No tab ID available to save state"});return}await b(s,{pageInfo:t.data.pageInfo,analysis:t.data.analysis,failedProviders:t.data.failedProviders,showButton:t.data.showButton,isAnalyzing:t.data.isAnalyzing||!1,hasAttemptedAnalysis:t.data.hasAttemptedAnalysis||!1,isViewingFromRecent:t.data.isViewingFromRecent||!1,originalTabId:t.data.originalTabId}),e({success:!0})}catch{e({success:!1,error:"Failed to save tab state"})}}async function z(t,a,e){try{const{callBackendWebSearch:r}=await Promise.resolve().then(()=>B),s=await r({title:t.query,url:t.originalUrl,limit:t.max_results||5});if(!s.success||!s.data){e({success:!1,error:s.error||"Failed to perform web search"});return}e({success:!0,data:{results:s.data}})}catch(r){console.error("Web search error:",r),e({success:!1,error:r instanceof Error?r.message:"Failed to perform web search"})}}async function U(t,a,e){try{const r=t.tabId,s=t.analysisData;if(F(r)){e({success:!1,error:"Tab already being set up"});return}O(r);const o={pageInfo:s.pageInfo,analysis:s.analysis,failedProviders:s.failedProviders,showButton:!1,isAnalyzing:!1,hasAttemptedAnalysis:!0,isViewingFromRecent:s.isViewingFromRecent||!1,originalTabId:s.originalTabId};await b(r,o),await b(r,{...o,hasPreloadedAnalysis:!0}),setTimeout(async()=>{try{try{await chrome.tabs.sendMessage(r,{type:"FNR_PING"})}catch{await chrome.scripting.executeScript({target:{tabId:r},files:["content-scripts/content.js"]})}setTimeout(async()=>{try{if(!await chrome.tabs.get(r)){y(r),e({success:!1,error:"Tab no longer exists"});return}o.isViewingFromRecent?chrome.tabs.sendMessage(r,{type:"TOGGLE_INJECTED_SIDEBAR",keepOpen:!0,preloadedAnalysis:o,hasPreloadedAnalysis:!0},n=>{if(chrome.runtime.lastError){y(r),e({success:!1,error:chrome.runtime.lastError.message});return}y(r),e({success:!0})}):(e({success:!0}),y(r))}catch{y(r),e({success:!1,error:"Failed to open sidebar"})}},200)}catch(c){console.error("Error setting up analysis tab:",c),y(r),e({success:!1,error:"Failed to setup analysis tab"})}},1e3)}catch(r){console.error("Error in LOAD_ANALYSIS_IN_TAB:",r),t.tabId&&y(t.tabId),e({success:!1,error:"Failed to load analysis in tab"})}}async function V(t,a,e){try{const r=await chrome.tabs.create({url:t.url});if(!r.id){e({success:!1,error:"Failed to create new tab"});return}const s=r.id;setTimeout(async()=>{try{await chrome.scripting.executeScript({target:{tabId:s},files:["content-scripts/content.js"]}),await new Promise((c,n)=>{const l=setTimeout(()=>{n(new Error("Content script not ready after 5 seconds"))},5e3);chrome.tabs.sendMessage(s,{type:"FNR_PING"},g=>{clearTimeout(l),chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):g!=null&&g.ok?c(!0):n(new Error("Content script not responding"))})}),e({success:!0})}catch(o){console.error("Error in sidebar setup:",o),e({success:!1,error:o instanceof Error?o.message:"Unknown error"})}},1e3)}catch(r){console.error("Error in NAVIGATE_AND_REOPEN_SIDEBAR:",r),e({success:!1,error:"Navigation failed"})}}async function W(t,a,e){var r,s;try{const{url:o,pageInfo:c,analysis:n,failedProviders:l}=t;if(!o||!n||n.length===0){e({success:!1,error:"Missing url or analysis"});return}const h=(await chrome.storage.local.get("recentAnalyses")).recentAnalyses||[],d=h.findIndex(i=>i.url===o),u={title:c.title||"Unknown Title",url:o,timestamp:Date.now(),score:((s=(r=n[0])==null?void 0:r.result)==null?void 0:s.credibility_score)||null,fullAnalysis:n,pageInfo:c,failedProviders:l||[]};d>=0?h[d]=u:h.unshift(u);const f=h.slice(0,50);await chrome.storage.local.set({recentAnalyses:f}),e({success:!0})}catch(o){console.error("Error in PRELOAD_URL_ANALYSIS:",o),e({success:!1,error:"Failed to preload analysis"})}}const $=k({main(){chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed")}),setInterval(L,5*60*1e3),chrome.action.onClicked.addListener(async()=>{try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))return;const a=o=>new Promise(c=>{let n=!1;try{chrome.tabs.sendMessage(o,{type:"FNR_PING"},l=>{if(chrome.runtime.lastError){n||(n=!0,c(!1));return}n||(n=!0,c(!!(l!=null&&l.ok)))})}catch{n||(n=!0,c(!1))}setTimeout(()=>{n||(n=!0,c(!1))},400)}),e=async()=>{try{await chrome.tabs.sendMessage(t.id,{type:"TOGGLE_INJECTED_SIDEBAR"})}catch(o){console.log("Toggle send error:",o)}};if(await a(t.id)){await e();return}try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content-scripts/content.js"]})}catch(o){console.log("Failed to inject content script:",o)}const s=await a(t.id);await e()}catch(t){console.log("Failed to toggle injected sidebar:",t)}}),chrome.tabs.onRemoved.addListener(t=>{P(t),y(t)}),chrome.tabs.onActivated.addListener(async t=>{try{chrome.runtime.sendMessage({type:"TAB_SWITCHED",tabId:t.tabId}).catch(()=>{})}catch(a){console.log("Error handling tab switch:",a)}}),chrome.runtime.onMessage.addListener((t,a,e)=>{switch(t.type){case"GET_PAGE_INFO":return x(t,a,e),!0;case"ANALYZE_ARTICLE":return C(t,a,e),!0;case"GET_TAB_STATE":return j(t,a,e),!0;case"RESET_TAB_STATE":return G(t,a,e),!0;case"SAVE_TAB_STATE":return M(t,a,e),!0;case"WEB_SEARCH":return z(t,a,e),!0;case"TAB_SWITCHED":return!0;case"LOAD_ANALYSIS_IN_TAB":return U(t,a,e),!0;case"NAVIGATE_AND_REOPEN_SIDEBAR":return V(t,a,e),!0;case"PRELOAD_URL_ANALYSIS":return W(t,a,e),!0;default:return!0}}),chrome.tabs.onUpdated.addListener(async(t,a,e)=>{if(a.status==="complete"&&e.url)try{await new Promise(r=>setTimeout(r,1e3))}catch(r){console.error("Error in tab update handler:",r)}})}});function J(){}(N=(D=globalThis.browser)==null?void 0:D.runtime)!=null&&N.id?globalThis.browser:globalThis.chrome;function S(t,...a){}const H={debug:(...t)=>S(console.debug,...t),log:(...t)=>S(console.log,...t),warn:(...t)=>S(console.warn,...t),error:(...t)=>S(console.error,...t)};let p;try{p=$.main(),p instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw H.error("The background crashed on startup!"),t}return p}();
background;
